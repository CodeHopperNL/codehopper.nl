<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Handling Microsoft Windows NTP sync &#8211; CodeHopper</title> <meta name="description" content="This post should raise some eyebrows around, as I’m advocating Linux since ages and I’m not at all into Microsoft stuff for the 99.99% of my time. This story comes out of that (usually negligible) 0.01%."> <meta name="keywords" content=""> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="logo.png"> <meta name="twitter:title" content="Handling Microsoft Windows NTP sync"> <meta name="twitter:description" content="This post should raise some eyebrows around, as I’m advocating Linux since ages and I’m not at all into Microsoft stuff for the 99.99% of my time. This story comes out of that (usually negligible) 0.01%."> <meta name="twitter:site" content="@skuro"> <meta name="twitter:creator" content="@skuro"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Handling Microsoft Windows NTP sync"> <meta property="og:description" content="This post should raise some eyebrows around, as I’m advocating Linux since ages and I’m not at all into Microsoft stuff for the 99.99% of my time. This story comes out of that (usually negligible) 0.01%."> <meta property="og:url" content="//codehopper.nl/2010/04/23/handling-microsoft-windows-ntp-sync/"> <meta property="og:site_name" content="CodeHopper"> <meta property="og:image" content="//codehopper.nl/img/logo.png"> <link rel="canonical" href="//codehopper.nl/2010/04/23/handling-microsoft-windows-ntp-sync/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="//codehopper.nl/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="/favicon.png" /> <link rel="shortcut icon" href="/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/default-post.png) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/post-list.png) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(/img/home.png) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left" style="background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/post/gear-clock-win.jpg) no-repeat; background-size: cover"> <div class="content"> <a href="/" class="logo"><img src="/img/logo-small.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Handling Microsoft Windows NTP sync </h1> <ul class="tags"> <li><a href="/tags#windows">windows</a></li> </ul> <div class="section-line reverse"><a href="/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> <a href="https://twitter.com/intent/tweet?text=//codehopper.nl/2010/04/23/handling-microsoft-windows-ntp-sync/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=//codehopper.nl/2010/04/23/handling-microsoft-windows-ntp-sync/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=//codehopper.nl/2010/04/23/handling-microsoft-windows-ntp-sync/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> </div> <a href="/posts.html" title="posts" class="posts-menu-icon"></a> <!-- a title="/projects" class="projects-menu-icon"> <span></span> </a --> <div class="inner-post content"> <nav class="pagination"> <a href="/2010/04/21/tales-from-an-icelandic-volcano-victim/" class="pagination_pager" title="Tales from an Icelandic volcano victim ">previous</a> <a href="/2010/05/23/spring-surf-meets-clojure/" class="pagination_pager" title="Spring Surf meets Clojure ">next</a> </nav> <div class="date-highlight">23 Apr 2010</div> <p>This post should raise some eyebrows around, as I’m advocating Linux since ages and I’m not at all into Microsoft stuff for the 99.99% of my time. This story comes out of that (usually negligible) 0.01%.</p> <h2 id="why-bother-with-ntp-on-ms-windows">Why bother with NTP on MS Windows?</h2> <p>The Alfresco implementation I’m working on has to integrate with a fully MS-powered environment, with a Domain Controller pulling the strings of network entities such as users and hosts. As the customer has strict security requirements, no remote access can be granted to their intranet, and since their offices are a bit far away from mine, we decided to replicate their environment locally, providing the minimum set of components such as</p> <ul> <li>a domain controller (WinServer 2k8)</li> <li>a domain host (WinXP Pro SP2)</li> <li>the Alfresco server (RHELv5.4)</li> </ul> <p>I was able to build up the whole replicated environment, with a relative limited effort, using virtual machines to host all the different operating system on my laptop. I was so happy that everything worked almost at the first shot that I almost died when it all went wrong after the first reboot of the VMs: I couldn’t log anymore on the WinXP box!</p> <p>It turned out that all clocks drifted away, making Kerberos auth checks fail because of replication attacks protection. Looked like it was time to strengthen my Win-fu and configure NTP in a proper way. This is what I learned.</p> <h2 id="winserver2k8-and-clock-management">WinServer2k8 and clock management</h2> <p>If there’s one thing I enjoyed out of all the time spent on these tasks, the prize goes definitely to w32tm: I had to deal with Windows, and there were no windows involved! As usual, whenever I’m typing into a command line, I feel at home. I’m actually writing this whole blog post to take note of the tricks I learned around w32tm and NTP clock sync. Here we go:</p> <ul> <li><strong>Configure NTP servers</strong> <blockquote><pre>w32tm /config /manualpeerlist:<a href="http://europe.pool.ntp.org" target="_blank">europe.pool.ntp.org</a> \
&nbsp;&nbsp;&nbsp;&nbsp; /syncfromflags:manual /reliable:no /update</pre></blockquote> </li> <li><strong>Query NTP servers</strong> <blockquote><pre>w32tm /stripchart /computer:<a href="http://europe.pool.ntp.org" target="_blank">europe.pool.ntp.org</a> \
&nbsp;&nbsp;&nbsp;&nbsp; /samples:5 /dataonly</pre></blockquote> </li> <li><strong>Resync clock</strong> <blockquote><pre>w32tm /resync /rediscover</pre></blockquote> </li> <li><strong>Allow resync in case of huge drifts</strong> If your clock drifted too far away Windows will refuse to sync. In order to disable such check you have to import the following changes (write them in a reg-keys.reg file and double click it): <blockquote><pre>Windows Registry Editor Version 5.00
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\Config]
"MaxNegPhaseCorrection"=dword:ffffffff
"MaxPosPhaseCorrection"=dword:ffffffff</pre></blockquote> </li> </ul> <p>That’s it for now. I hope this will come in handy to somebody else, since I’ll try to avoid any more contact with the Microsoft stacks as long as possible, since without grep, find, awk, sed, vim I feel as uncomfortable as <a href="http://farm4.static.flickr.com/3290/2615393415_0d9e8eb97d.jpg">this</a>.</p> <br> <a href="https://twitter.com/intent/tweet?text=//codehopper.nl/2010/04/23/handling-microsoft-windows-ntp-sync/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=//codehopper.nl/2010/04/23/handling-microsoft-windows-ntp-sync/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=//codehopper.nl/2010/04/23/handling-microsoft-windows-ntp-sync/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> <nav class="pagination"> <a href="/2010/04/21/tales-from-an-icelandic-volcano-victim/" class="pagination_pager" title="Tales from an Icelandic volcano victim ">previous</a> <a href="/2010/05/23/spring-surf-meets-clojure/" class="pagination_pager" title="Spring Surf meets Clojure ">next</a> </nav> <br /> <div id="disqus_thread"></div> <script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/ /* var disqus_config = function () { this.page.url = PAGE_URL; this.page.identifier = PAGE_IDENTIFIER; }; */ (function() { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = '//skuro.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </div> <!-- JS --> <script src="/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://taylantatli.me/Halve/images/halve-home-image.png) center center no-repeat;"> <a href="http://taylantatli.me/Halve" class="inactive" target="_blank" rel="nofollow external"> <span> Halve Jekyll Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://cloud.githubusercontent.com/assets/754514/14509720/61c61058-01d6-11e6-93ab-0918515ecd56.png) center center no-repeat;"> <a href="http://taylantatli.me/Moon" target="_blank" rel="nofollow external"> <span> Moon Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Ramme/master/assets/img/screenshot-post.png) center center no-repeat;"> <a href="http://taylantatli.me/Ramme" target="_blank" rel="nofollow external"> <span> Ramme Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Daisy-Pelican-Theme/master/Preview-1.png) center center no-repeat;"> <a href="http://taylantatli.me/Daisy-Pelican-Theme/" target="_blank" rel="nofollow external"> <span> Daisy Pelican Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Block-Icon-Theme/master/Preview.png) center center no-repeat;"> <a href="https://github.com/TaylanTatli/Block-Icon-Theme" class="inactive" target="_blank" rel="nofollow external"> <span> Block Icon Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/StartPage/master/preview.png) center center no-repeat;"> <a href="http://taylantatli.me/StartPage/" class="inactive" target="_blank" rel="nofollow external"> <span> Start Page <br><em>in progress</em> </span> </a> </li> </ul> </div> </body> </html>
