<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Java StringBuilder myth debunked – now with content! &#8211; CodeHopper</title> <meta name="description" content="The myth"> <meta name="keywords" content=""> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/img/logo.png"> <meta name="twitter:title" content="Java StringBuilder myth debunked -- now with content!"> <meta name="twitter:description" content="The myth"> <meta name="twitter:site" content="@skuro"> <meta name="twitter:creator" content="@skuro"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Java StringBuilder myth debunked -- now with content!"> <meta property="og:description" content="The myth"> <meta property="og:url" content="http://localhost:4000/2013/03/11/java-stringbuilder-myth-now-with-content/"> <meta property="og:site_name" content="CodeHopper"> <meta property="og:image" content="http://localhost:4000/img/logo.png"> <link rel="canonical" href="http://localhost:4000/2013/03/11/java-stringbuilder-myth-now-with-content/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="CodeHopper" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="/favicon.png" /> <link rel="shortcut icon" href="/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/default-post.png) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/post-list.png) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(/img/home.png) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left" style="background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/post/joint.png) no-repeat; background-size: cover"> <div class="content"> <a href="/" class="logo"><img src="/img/logo-small.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Java StringBuilder myth debunked – now with content! </h1> <ul class="tags"> <li><a href="/tags#java">java</a></li> <li><a href="/tags#performance">performance</a></li> <li><a href="/tags#development">development</a></li> </ul> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2013/03/11/java-stringbuilder-myth-now-with-content/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2013/03/11/java-stringbuilder-myth-now-with-content/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://news.ycombinator.com/submitlink?u=http://localhost:4000/2013/03/11/java-stringbuilder-myth-now-with-content/" class="btn btn_hn" title="Share on Hacker News"><i class="fa fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a> <div class="section-line reverse"><a href="/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="inner-post content"> <nav class="pagination"> <a href="/2013/03/10/observer-pattern-spring-framework/" class="pagination_pager" title="The Observer Pattern in Spring ">&lt; The Observer Pattern in Spring</a> <a href="/2013/03/27/h2-support-for-alfresco-3-4-12-and-maven/" class="pagination_pager" title="H2 support 1.1.1 for Alfresco 3.4.12 Enterprise with Maven ">H2 support 1.1.1 for Alfres... &gt;</a> </nav> <div class="date-highlight">11 Mar 2013</div> <h1 id="the-myth">The myth</h1> <blockquote> <p>Concatenating two Strings with the plus operator is the source of all evil</p> <p>– Anonymous Java dev</p> </blockquote> <p><em><strong>NOTE</strong>: The source code for the tests discussed here can be found on <a href="https://github.com/skuro/stringbuilder">Github</a></em></p> <p>It’s from university time that I learned to regard <code class="highlighter-rouge">String</code> concatenation in Java using the ‘+’ plus operator as a deadly performance sin. Recently there has been an internal review at <a href="http://www.backbase.com">Backbase R&amp;D</a> where such recurring mantra was dismissed as a myth due to <code class="highlighter-rouge">javac</code> using <code class="highlighter-rouge">StringBuilder</code> under the hood any time you use the plus operator to join Strings. I set myself up to prove such a point and verify the reality under different environments.</p> <h1 id="the-test">The test</h1> <p>Relying on your compiler to optimize your <code class="highlighter-rouge">String</code> concatenation means that things might change heavily depending on the JDK vendor you adopt. As far as platform support goes for my daily job, three main vendors should be considered:</p> <ul> <li>Oracle JDK</li> <li>IBM JDK</li> <li>ECJ – for developers only</li> </ul> <p>Moreover, while we officially support Java 5 through 6, we are also looking into supporting Java 7 for our products, adding another three-folded level of indirection on top of the three vendors. For the sake of <del>lazyness</del> simplicity, the <code class="highlighter-rouge">ecj</code> compiled bytecode will be run with a single JDK, namely Oracle JDK7.</p> <p>I prepared a <a href="https://www.virtualbox.org/">Virtualbox</a> VM with all the above JDK installed, then I developed some classes to express three different concatenation methods, amounting to three to four concatenations per method invocaiton, depending on the specific test case.</p> <p>The test classes are run a thousands times for each test round, with a total of 100 rounds each test case. The same VM is used to run all the rounds for the same test case, and it’s restarted across different test cases, all to let the Java runtime perform all the optimizations it can, without affecting the other test cases in any way. The default options were used to start all JVMs.</p> <p>More details can be found in the benchmark runner <a href="https://github.com/skuro/stringbuilder/blob/master/bench.sh">script</a>.</p> <h1 id="the-code">The code</h1> <p>Full code for both test cases and the test suite is available on <a href="https://github.com/skuro/stringbuilder">Github</a>.</p> <p>The following different test cases were produced to measure performance differences of the String concatenation with plus against the direct use of a <code class="highlighter-rouge">StringBuilder</code>:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// String concat with plus
String result = "const1" + base;
result = result + "const2";
</code></pre></div></div> <hr /> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// String concat with a StringBuilder
new StringBuilder()
              .append("const1")
              .append(base)
              .append("const2")
              .append(append)
              .toString();
}
</code></pre></div></div> <hr /> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//String concat with an initialized StringBuilder
new StringBuilder("const1")
              .append(base)
              .append("const2")
              .append(append)
              .toString();
</code></pre></div></div> <p>The general idea is to provide a concatenation both at the head and at the tail of constant <code class="highlighter-rouge">String</code>s over a variable. The difference between the last two cases, both making explicit use of <code class="highlighter-rouge">StringBuilder</code>, is in the latter using the 1-arg constructor which initializes the builder with the initial part of the result.</p> <h1 id="the-results">The results</h1> <p>Enough talking, down below here you can have a look at the generated graphs, where each data point corresponds to a single test round (e.g. 1000 executions of the same test class).</p> <p>The discussion of the results and some more juicy details will follow.</p> <h2><img src="/img/post/catplus.png" alt="Concatenation with plus" title="Concatenation with plus" /></h2> <p><img src="/img/post/catsb.png" alt="Concatenation with StringBuilder" title="Concatenation with StringBuilder" /> —- <img src="/img/post/catsb2.png" alt="Concatenation with initialized StringBuilder" title="Concatenation with initalized StringBuilder" /></p> <h1 id="the-discussion">The discussion</h1> <p>Oracle JKD5 is the clear loser here, appearing to be in a B league when compared to the others. But that’s not really the scope of this exercise, and thus we’ll gloss over it for the time being.</p> <p>That said, there are two other interesting bits I observe in the above graph. The first is that indeed there is generally quite a difference between the use of the plus operator vs an explicit <code class="highlighter-rouge">StringBuilder</code>, <em>especially</em> if you’re using Oracle Java5 which performs tree times worse the the rest of the crew.</p> <p>The second observation is that while it generally holds for most of the JDKs that an explicit <code class="highlighter-rouge">StringBuilder</code> will offer up to twice the speed as the regular plus operator, <strong>IBM JDK6 seems not to suffer</strong> from any performance loss, always averaging 25ms to complete the task in all test cases.</p> <p>A closer look at the generated bytecode reveals some interesting details</p> <h1 id="the-bytecode">The bytecode</h1> <p><em><strong>NOTE:</strong> the decompiled classes are also available on <a href="https://github.com/skuro/stringbuilder">Github</a></em></p> <p>Across all possible JDKs <code class="highlighter-rouge">StringBuilders</code> are <strong>always</strong> used to implement <code class="highlighter-rouge">String</code> concatenation even in presence of a plus sign. Moreover, across all vendors and versions, <strong>there is almost no difference at all</strong> for the same test case. The only one that stands a bit apart is <a href="https://github.com/skuro/stringbuilder/blob/master/ecj/CatPlus.class.txt"><code class="highlighter-rouge">ecj</code></a>, which is the only one to cleverly optimize the <code class="highlighter-rouge">CatPlus</code> test case to invoke the 1-arg constructor of the <code class="highlighter-rouge">StringBuilder</code> instead of the 0-arg version.</p> <p>Comparing the resulting bytecode exposes what could affect performance in the different scnarios:</p> <ul> <li> <p>when concatenating with plus, <em>new instances of <code class="highlighter-rouge">StringBuilder</code></em> are created any time a concatenation happens. This can easily result in a performance degradation due to useless invocation of the constructor plus more stress on the garbage collector due to throw away instances</p> </li> <li> <p>compilers will take you literally and only initalize <code class="highlighter-rouge">StringBuilder</code> with its 1-arg constructor if and only if you write it that way in the original code. This results in respectively four and three invocations of <code class="highlighter-rouge">StringBuilder.append</code> for <a href="https://github.com/skuro/stringbuilder/blob/master/ecj/CatSB.class.txt">CatSB</a> and <a href="https://github.com/skuro/stringbuilder/blob/master/ecj/CatSB2.class.txt">CatSB2</a>.</p> </li> </ul> <h1 id="the-conclusion">The conclusion</h1> <p>Bytecode analysis offers the final answer to the original question.</p> <blockquote> <p>Do you need to explicitly use a <code class="highlighter-rouge">StringBuilder</code> to improve performance? <strong>Yes</strong></p> </blockquote> <p>The above graphs clearly show that, unless you’re using IBM JDK6 runtime, you will loss 50% performance when using the plus operator, although it’s the one to perform slightly worse across the candidates when expliciting <code class="highlighter-rouge">StringBuilder</code>s.</p> <p>Also, it’s quite interesting to see how <em>JIT optimizations</em> impact the overall performance: for instance, even in presence of different bytecode between the two explicit <code class="highlighter-rouge">StringBuilder</code> test cases, the end result is absolutely the same in the long run.</p> <p><img src="/img/post/myth-confirmed.jpg" alt="Myth confirmed" /></p> <br> <nav class="pagination"> <a href="/2013/03/10/observer-pattern-spring-framework/" class="pagination_pager" title="The Observer Pattern in Spring ">&lt; The Observer Pattern in Spring</a> <a href="/2013/03/27/h2-support-for-alfresco-3-4-12-and-maven/" class="pagination_pager" title="H2 support 1.1.1 for Alfresco 3.4.12 Enterprise with Maven ">H2 support 1.1.1 for Alfres... &gt;</a> </nav> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2013/03/11/java-stringbuilder-myth-now-with-content/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2013/03/11/java-stringbuilder-myth-now-with-content/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://news.ycombinator.com/submitlink?u=http://localhost:4000/2013/03/11/java-stringbuilder-myth-now-with-content/" class="btn btn_hn" title="Share on Hacker News"><i class="fa fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a> <br /> </div> </div> <!-- JS --> <script src="/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://taylantatli.me/Halve/images/halve-home-image.png) center center no-repeat;"> <a href="http://taylantatli.me/Halve" class="inactive" target="_blank" rel="nofollow external"> <span> Halve Jekyll Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://cloud.githubusercontent.com/assets/754514/14509720/61c61058-01d6-11e6-93ab-0918515ecd56.png) center center no-repeat;"> <a href="http://taylantatli.me/Moon" target="_blank" rel="nofollow external"> <span> Moon Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Ramme/master/assets/img/screenshot-post.png) center center no-repeat;"> <a href="http://taylantatli.me/Ramme" target="_blank" rel="nofollow external"> <span> Ramme Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Daisy-Pelican-Theme/master/Preview-1.png) center center no-repeat;"> <a href="http://taylantatli.me/Daisy-Pelican-Theme/" target="_blank" rel="nofollow external"> <span> Daisy Pelican Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Block-Icon-Theme/master/Preview.png) center center no-repeat;"> <a href="https://github.com/TaylanTatli/Block-Icon-Theme" class="inactive" target="_blank" rel="nofollow external"> <span> Block Icon Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/StartPage/master/preview.png) center center no-repeat;"> <a href="http://taylantatli.me/StartPage/" class="inactive" target="_blank" rel="nofollow external"> <span> Start Page <br><em>in progress</em> </span> </a> </li> </ul> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-6754361-4', 'auto'); ga('send', 'pageview'); </script> </body> </html>
