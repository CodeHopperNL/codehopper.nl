<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>gcloud and kubectl on GCP ubuntu images &#8211; CodeHopper</title> <meta name="description" content=" morning glory!the well bucket-entangled,I ask for water– Fukuda Chiyo-ni"> <meta name="keywords" content=""> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/img/logo.png"> <meta name="twitter:title" content="gcloud and kubectl on GCP ubuntu images"> <meta name="twitter:description" content=" morning glory!the well bucket-entangled,I ask for water– Fukuda Chiyo-ni"> <meta name="twitter:site" content="@skuro"> <meta name="twitter:creator" content="@skuro"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="gcloud and kubectl on GCP ubuntu images"> <meta property="og:description" content=" morning glory!the well bucket-entangled,I ask for water– Fukuda Chiyo-ni"> <meta property="og:url" content="http://localhost:4000/2019/10/11/gcloud-and-kubectl-on-gcp-ubuntu/"> <meta property="og:site_name" content="CodeHopper"> <meta property="og:image" content="http://localhost:4000/img/logo.png"> <link rel="canonical" href="http://localhost:4000/2019/10/11/gcloud-and-kubectl-on-gcp-ubuntu/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="CodeHopper" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="/favicon.png" /> <link rel="shortcut icon" href="/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/default-post.png) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/post-list.png) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(/img/home.png) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left" style="background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/post/entangled.jpg) no-repeat; background-size: cover"> <div class="content"> <a href="/" class="logo"><img src="/img/logo-small.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">gcloud and kubectl on GCP ubuntu images </h1> <ul class="tags"> <li><a href="/tags#kubernetes">kubernetes</a></li> <li><a href="/tags#gcp">gcp</a></li> <li><a href="/tags#google">google</a></li> <li><a href="/tags#cloud">cloud</a></li> <li><a href="/tags#devops">devops</a></li> </ul> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2019/10/11/gcloud-and-kubectl-on-gcp-ubuntu/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2019/10/11/gcloud-and-kubectl-on-gcp-ubuntu/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://news.ycombinator.com/submitlink?u=http://localhost:4000/2019/10/11/gcloud-and-kubectl-on-gcp-ubuntu/" class="btn btn_hn" title="Share on Hacker News"><i class="fa fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a> <div class="section-line reverse"><a href="/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="inner-post content"> <nav class="pagination"> <a href="/2018/09/27/clojure-gitlab-deps/" class="pagination_pager" title="Clojure GitLab deps ">&lt; Clojure GitLab deps</a> <a href="#" class="pagination_pager disabled">next</a> </nav> <div class="date-highlight">11 Oct 2019</div> <blockquote> <p>morning glory!<br /> the well bucket-entangled,<br /> I ask for water<br /> – Fukuda Chiyo-ni</p> </blockquote> <h2 id="yet-another-versioning-issue">Yet another versioning issue</h2> <p>Versioning is <a href="/2018/05/28/a-tale-of-emacs-clojure-and-pinned-packages/">a recurring PITA in my life</a>, it seems. Today I ran (for the second time on the same machine, actually) into an issue with <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/"><code class="highlighter-rouge">kubectl</code></a> commands run from my CI server:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get https://172.16.0.2/api?timeout=32s: error executing access token command "/snap/google-cloud-sdk/100/bin/gcloud config config-helper --format=json": err=fork/exec /snap/google-cloud-sdk/100/bin/gcloud: no such file or directory output= stderr=
</code></pre></div></div> <p>The actual error message was longer than that, but it basically tells me that my <code class="highlighter-rouge">kubectl</code> commands that I run to deploy new versions of some applications in our <code class="highlighter-rouge">k8s</code> cluster failed. More specifically, it encountered an <code class="highlighter-rouge">error executing acces token command ...</code>. What’s that? And how to fix it? Well there are a few ingredients to the mix.</p> <h3 id="tldr">tl;dr</h3> <p>Use the <code class="highlighter-rouge">/snap/google-cloud-sdk/current</code> symlink instead of the bespoke snap version number of your <code class="highlighter-rouge">gcloud</code> SDK:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-E</span> <span class="nt">-ibak</span> <span class="s1">'s/(\/snap\/google-cloud-sdk\/)(.*)(\/bin\/gcloud)/\1current\3/'</span> ~/.kube/config
</code></pre></div></div> <p>Explanation:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sed</span> <span class="nt">-E</span>             <span class="c"># extended regex</span>
    <span class="nt">-ibak</span>          <span class="c"># edit in place, create a ~/.kube/config.bak backup file</span>
    <span class="s1">'s/(\/snap\/google-cloud-sdk\/)(.*)(\/bin\/gcloud)/\1current\3/'</span> <span class="c"># replace the version number with `current`</span>
    ~/.kube/config <span class="c"># file to update</span>
</code></pre></div></div> <h3 id="authentication-in-kubectl">Authentication in <code class="highlighter-rouge">kubectl</code></h3> <p>If you want more low level details you should definitely go to <a href=" https://kubernetes.io/docs/reference/access-authn-authz/authentication/">the official documentation</a>. Here, suffice it so say that I used the following command to configure my <code class="highlighter-rouge">kubectl</code> access to the cluster[<a href="https://cloud.google.com/sdk/gcloud/reference/container/clusters/get-credentials">↪</a>]:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud container clusters get-credentials &lt;my-cluster-name&gt; --zone &lt;my-cluster-zone&gt;
</code></pre></div></div> <p>That’s automagically creating your <code class="highlighter-rouge">~/.kube/config</code> file with everything you need to connect to a specific cluster. Then you’re supposed to <code class="highlighter-rouge">kubectl</code> happily ever after, with <code class="highlighter-rouge">gcloud</code> being directly invoked to retrieve the authentication tokens automagically. Until..</p> <h3 id="oh-snap">Oh, snap!</h3> <p>The thing I didn’t expect was a poor synergy with the Google Cloud SDK installation and the produced <code class="highlighter-rouge">kubectl</code> configuration. There’s a few ingredients to the mix:</p> <ul> <li>the machine that’s running all of the above commands was created using the Google official <a href="https://cloud.google.com/compute/docs/images#os-compute-support"><code class="highlighter-rouge">ubuntu-1804-lts</code> image</a></li> <li>in that machine, the Google Cloud SDK is installed using [Snapcraft][https://snapcraft.io/]</li> <li><code class="highlighter-rouge">gcloud</code> stores it’s own binary <em>full path</em> within <code class="highlighter-rouge">~/.kubectl/config</code> which is what shows up in the above error message, e.g.:</li> </ul> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">auth-provider</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="s">...</span>
        <span class="s">cmd-args</span><span class="pi">:</span> <span class="s">config config-helper --format=json</span>
        <span class="na">cmd-path</span><span class="pi">:</span> <span class="s">/snap/google-cloud-sdk/100/bin/gcloud</span>

</code></pre></div></div> <ul> <li>snaps are updated <a href="https://snapcraft.io/docs/keeping-snaps-up-to-date">frequently</a>, installing new versions into <code class="highlighter-rouge">/snap/google-cloud-sdk/$VERSION</code></li> </ul> <p>The salvation is provided by the <code class="highlighter-rouge">/snap/google-cloud-sdk/current</code> symlink which is always updated by <code class="highlighter-rouge">snapd</code> upon installation, making the <code class="highlighter-rouge">sed</code> script above fix the issue once and for all. Kinda. There are multiple users on the machine I’m using, and the above configuration is user specific. Hence why I faced this issue <em>twice</em> on the same machine. Welp.</p> <br> <nav class="pagination"> <a href="/2018/09/27/clojure-gitlab-deps/" class="pagination_pager" title="Clojure GitLab deps ">&lt; Clojure GitLab deps</a> <a href="#" class="pagination_pager disabled">next</a> </nav> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2019/10/11/gcloud-and-kubectl-on-gcp-ubuntu/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2019/10/11/gcloud-and-kubectl-on-gcp-ubuntu/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://news.ycombinator.com/submitlink?u=http://localhost:4000/2019/10/11/gcloud-and-kubectl-on-gcp-ubuntu/" class="btn btn_hn" title="Share on Hacker News"><i class="fa fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a> <br /> </div> </div> <!-- JS --> <script src="/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://taylantatli.me/Halve/images/halve-home-image.png) center center no-repeat;"> <a href="http://taylantatli.me/Halve" class="inactive" target="_blank" rel="nofollow external"> <span> Halve Jekyll Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://cloud.githubusercontent.com/assets/754514/14509720/61c61058-01d6-11e6-93ab-0918515ecd56.png) center center no-repeat;"> <a href="http://taylantatli.me/Moon" target="_blank" rel="nofollow external"> <span> Moon Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Ramme/master/assets/img/screenshot-post.png) center center no-repeat;"> <a href="http://taylantatli.me/Ramme" target="_blank" rel="nofollow external"> <span> Ramme Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Daisy-Pelican-Theme/master/Preview-1.png) center center no-repeat;"> <a href="http://taylantatli.me/Daisy-Pelican-Theme/" target="_blank" rel="nofollow external"> <span> Daisy Pelican Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Block-Icon-Theme/master/Preview.png) center center no-repeat;"> <a href="https://github.com/TaylanTatli/Block-Icon-Theme" class="inactive" target="_blank" rel="nofollow external"> <span> Block Icon Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/StartPage/master/preview.png) center center no-repeat;"> <a href="http://taylantatli.me/StartPage/" class="inactive" target="_blank" rel="nofollow external"> <span> Start Page <br><em>in progress</em> </span> </a> </li> </ul> </div> <script data-goatcounter="https://codehopper.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> </body> </html>
