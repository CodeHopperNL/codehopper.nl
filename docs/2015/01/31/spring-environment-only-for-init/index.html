<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Spring Environment is for initialization code only &#8211; CodeHopper</title> <meta name="description" content="Since version 3.1, the Spring framework offers an abstraction towards several differentsources through which you can easily configure your application: the Environment."> <meta name="keywords" content=""> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/img/logo.svg"> <meta name="twitter:title" content="Spring Environment is for initialization code only"> <meta name="twitter:description" content="Since version 3.1, the Spring framework offers an abstraction towards several differentsources through which you can easily configure your application: the Environment."> <meta name="twitter:site" content="@skuro"> <meta name="twitter:creator" content="@skuro"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Spring Environment is for initialization code only"> <meta property="og:description" content="Since version 3.1, the Spring framework offers an abstraction towards several differentsources through which you can easily configure your application: the Environment."> <meta property="og:url" content="http://localhost:4000/2015/01/31/spring-environment-only-for-init/"> <meta property="og:site_name" content="CodeHopper"> <meta property="og:image" content="http://localhost:4000/img/logo.svg"> <link rel="canonical" href="http://localhost:4000/2015/01/31/spring-environment-only-for-init/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="CodeHopper" /> <!-- Favicons --> <link rel="shortcut icon" type="image/svg+xml" href="/img/logo.svg" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/default-post.png) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/post-list.png) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(/img/home.png) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left" style="background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/post/spring-by-pivotal.png) no-repeat; background-size: cover"> <div class="content"> <a aria-label="Go to the homepage" href="/" class="logo"><img alt="Code Hopper small logo" src="/img/logo.svg"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Spring Environment is for initialization code only </h1> <ul class="tags"> <li><a href="/tags#java">java</a></li> <li><a href="/tags#performance">performance</a></li> </ul> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2015/01/31/spring-environment-only-for-init/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2015/01/31/spring-environment-only-for-init/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://news.ycombinator.com/submitlink?u=http://localhost:4000/2015/01/31/spring-environment-only-for-init/" class="btn btn_hn" title="Share on Hacker News"><i class="fa fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a> <div class="section-line reverse"><a href="/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="inner-post content"> <nav class="pagination"> <a href="/2014/07/06/alfresco-h2-support-new-releases-version-scheme/" class="pagination_pager" title="Alfresco H2 support releases and versioning scheme ">&lt; Alfresco H2 support release...</a> <a href="/2015/03/01/colemak-best-keyboard-for-clojurists/" class="pagination_pager" title="The best keyboard layout for Clojurists ">The best keyboard layout fo... &gt;</a> </nav> <div class="date-highlight">31 Jan 2015</div> <p>Since version 3.1, the <a href="https://spring.io/">Spring framework</a> offers an abstraction towards several different sources through which you can easily configure your application: the <a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/env/Environment.html"><code class="highlighter-rouge">Environment</code></a>.</p> <p>In this post I describe a micro benchmark that I ran to prove that, while it’s a convenient API if you’re using Spring in your application, it might introduce a performance penalty for which you should not use it outside of your initialization code.</p> <h1 id="how-it-works">How it works</h1> <p>Before getting into the numbers, a quick digression on the internals of the <code class="highlighter-rouge">Environment</code> that are important to this post.</p> <p>From the documentation:</p> <blockquote> <blockquote> <p><em>Properties play an important role in almost all applications, and may originate from a variety of sources: properties files, JVM system properties, system environment variables, JNDI, servlet context parameters, ad-hoc Properties objects, Maps, and so on. The role of the environment object with relation to properties is to provide the user with a convenient service interface for configuring property sources and resolving properties from them.</em></p> </blockquote> </blockquote> <p>So, you can use the <code class="highlighter-rouge">Environment</code> to have a common interface to properties provided with different strategies, using a simple <code class="highlighter-rouge">getProperty</code> call to access the required value. Look at the following Groovy code:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Component</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Greeter</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">Environment</span> <span class="n">environment</span>

        <span class="nd">@Autowired</span>
        <span class="kd">public</span> <span class="nc">Greeter</span> <span class="nf">greeter</span><span class="o">(</span><span class="nc">Environment</span> <span class="n">environment</span><span class="o">){</span>
            <span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="o">}</span>

        <span class="n">def</span> <span class="nf">nickName</span><span class="o">(</span><span class="n">user</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span> <span class="c1">// here be magic</span>
        <span class="o">}</span>

        <span class="n">def</span> <span class="nf">greet</span><span class="o">(</span><span class="n">user</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">def</span> <span class="n">nick</span> <span class="o">=</span> <span class="n">nickName</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">println</span> <span class="s">"Hi, ${user}!"</span>
                         <span class="k">else</span> <span class="n">println</span> <span class="s">"Hi, ${nick}!"</span>
        <span class="o">}</span>

    <span class="o">}</span>
</code></pre></div></div> <p>Now, I can specify nicknames in a properties file so that I can greet know users with a more familiar nick name, still being able to salute also users which are not given a nickname. Neat, but how about performance?</p> <h1 id="the-hidden-exception">The hidden Exception</h1> <p>I got into this exercise while debugging a couple of slow pages in the website I’m working on: the <a href="http://www.klm.com/destinations/nl/en/search">destinations pages</a> of the KLM main site. While performance is generally satisfactory, two pages were constantly giving above second response times. Definitely <a href="http://www.vm.ibm.com/devpages/jelliott/evrrt.html">too much</a>.</p> <p>In our code, we were translating some country names into queriable keys for an external services. We also needed to override an otherwise straightforward translation algorithm with very specific exceptions to the rule. The actual code was pretty much like the above <code class="highlighter-rouge">Greeter.greet(user)</code>, and a <a href="http://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/run.htm">Flight Recorder</a> session eventually provided us with the performance bottleneck (click to open):</p> <p><a href="/img/post/exceptions.png"><img style="width: 500px" src="/img/post/exceptions.png" /></a></p> <p>For 12 page refreshes we were silently throwing 140k+ exceptions. And exceptions are <a href="http://java-performance.info/throwing-an-exception-in-java-is-very-slow/">sloooooow</a>, even if you just create them.</p> <p>Looking at the top thrown exception, it was actually pretty easy to understand what’s going on: the <code class="highlighter-rouge">Environment</code> checks whether the requested property is defined in the current JNDI context. But, if the name is not found, a <a href="http://docs.oracle.com/javase/8/docs/api/javax/naming/NameNotFoundException.html"><code class="highlighter-rouge">NameNotFoundException</code></a> is thrown. In our specific case we were using property lookup for <em>exceptional</em> cases, which means the vast majority of cases resulted in an exception being thrown.</p> <h1 id="micro-benchmark">Micro benchmark</h1> <p>I put together a <a href="https://gist.github.com/skuro/648cf1d871d203a73a0c">micro benchmark</a> to evaluate the potential performance gain of the original property lookup strategy versus a simpler one where relevant properties are loaded up at class construction time. I used the <a href="http://openjdk.java.net/projects/code-tools/jmh/">Java Microbenchmark Harness</a>, which does an incredible job at making micro benchmarks easy on the JVM: JIT, warm up, class loading, all is taken care of for you and you can just go ahead and put your code under test. Here the results (higher numbers better):</p> <blockquote> <blockquote> <p>[Property lookup per invocation]</p> <p>Result: 28917.876 ?(99.9%) 183.630 ops/s [Average] <br /> Statistics: (min, avg, max) = (25688.067, 28917.876, 30976.876), stdev = 777.500 <br /> <strong>Confidence interval (99.9%): [28734.246, 29101.505]</strong></p> </blockquote> </blockquote> <hr /> <blockquote> <blockquote> <p>[Property loading at class construction]</p> <p>Result: 159062.900 ?(99.9%) 1013.309 ops/s [Average] <br /> Statistics: (min, avg, max) = (138707.926, 159062.900, 177183.549), stdev = 4290.413 <br /> <strong>Confidence interval (99.9%): [158049.591, 160076.209]</strong></p> </blockquote> </blockquote> <p>As expected, five times as fast.</p> <h1 id="conclusions">Conclusions</h1> <p>I’m not a big fan of Spring, but if you’re using it the <code class="highlighter-rouge">Environment</code> class is a dead easy interface to your application configuration. But, unless you’re using JNDI as your main store of configuration properties, its performance characteristics make it a great tool only if you’re using it in your initialization code, and not during on-line processing of requests.</p> <br> <nav class="pagination"> <a href="/2014/07/06/alfresco-h2-support-new-releases-version-scheme/" class="pagination_pager" title="Alfresco H2 support releases and versioning scheme ">&lt; Alfresco H2 support release...</a> <a href="/2015/03/01/colemak-best-keyboard-for-clojurists/" class="pagination_pager" title="The best keyboard layout for Clojurists ">The best keyboard layout fo... &gt;</a> </nav> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2015/01/31/spring-environment-only-for-init/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2015/01/31/spring-environment-only-for-init/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://news.ycombinator.com/submitlink?u=http://localhost:4000/2015/01/31/spring-environment-only-for-init/" class="btn btn_hn" title="Share on Hacker News"><i class="fa fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a> <br /> </div> </div> <!-- JS --> <script src="https://giscus.app/client.js" data-repo="CodeHopperNL/codehopper.nl" data-repo-id="MDEwOlJlcG9zaXRvcnk3NTE3NjIwNg==" data-category="Announcements" data-category-id="DIC_kwDOBHsZDs4CrhvA" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="noborder_light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script> <!-- JS --> <script src="/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://taylantatli.me/Halve/images/halve-home-image.png) center center no-repeat;"> <a href="http://taylantatli.me/Halve" class="inactive" target="_blank" rel="nofollow external"> <span> Halve Jekyll Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://cloud.githubusercontent.com/assets/754514/14509720/61c61058-01d6-11e6-93ab-0918515ecd56.png) center center no-repeat;"> <a href="http://taylantatli.me/Moon" target="_blank" rel="nofollow external"> <span> Moon Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Ramme/master/assets/img/screenshot-post.png) center center no-repeat;"> <a href="http://taylantatli.me/Ramme" target="_blank" rel="nofollow external"> <span> Ramme Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Daisy-Pelican-Theme/master/Preview-1.png) center center no-repeat;"> <a href="http://taylantatli.me/Daisy-Pelican-Theme/" target="_blank" rel="nofollow external"> <span> Daisy Pelican Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Block-Icon-Theme/master/Preview.png) center center no-repeat;"> <a href="https://github.com/TaylanTatli/Block-Icon-Theme" class="inactive" target="_blank" rel="nofollow external"> <span> Block Icon Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/StartPage/master/preview.png) center center no-repeat;"> <a href="http://taylantatli.me/StartPage/" class="inactive" target="_blank" rel="nofollow external"> <span> Start Page <br><em>in progress</em> </span> </a> </li> </ul> </div> <script data-goatcounter="https://codehopper.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> </body> </html>
