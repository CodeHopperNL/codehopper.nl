<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Performance boost in Clojure 1.3 (alpha4) &#8211; CodeHopper</title> <meta name="description" content="As release 1.3 of Clojure is on its way, I decided to give the currently available alpha4 a try and see some of the good stuff it brings. First thing first, I wanted to experiment myself with the performance gain that the extended support for native types would bring. I ran into an old post from which I got the inspiration for the specific test to run: the Takeuchi function."> <meta name="keywords" content=""> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/img/logo.png"> <meta name="twitter:title" content="Performance boost in Clojure 1.3 (alpha4)"> <meta name="twitter:description" content="As release 1.3 of Clojure is on its way, I decided to give the currently available alpha4 a try and see some of the good stuff it brings. First thing first, I wanted to experiment myself with the performance gain that the extended support for native types would bring. I ran into an old post from which I got the inspiration for the specific test to run: the Takeuchi function."> <meta name="twitter:site" content="@skuro"> <meta name="twitter:creator" content="@skuro"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Performance boost in Clojure 1.3 (alpha4)"> <meta property="og:description" content="As release 1.3 of Clojure is on its way, I decided to give the currently available alpha4 a try and see some of the good stuff it brings. First thing first, I wanted to experiment myself with the performance gain that the extended support for native types would bring. I ran into an old post from which I got the inspiration for the specific test to run: the Takeuchi function."> <meta property="og:url" content="http://localhost:4000/2011/01/24/performance-boost-in-clojure-1-3/"> <meta property="og:site_name" content="CodeHopper"> <meta property="og:image" content="http://localhost:4000/img/logo.png"> <link rel="canonical" href="http://localhost:4000/2011/01/24/performance-boost-in-clojure-1-3/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="CodeHopper" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="/favicon.png" /> <link rel="shortcut icon" href="/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/default-post.png) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/post-list.png) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(/img/home.png) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left" style="background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/img/default-post.png) no-repeat; background-size: cover"> <div class="content"> <a href="/" class="logo"><img src="/img/logo-small.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Performance boost in Clojure 1.3 (alpha4) </h1> <ul class="tags"> <li><a href="/tags#clojure">clojure</a></li> </ul> <div class="section-line reverse"><a href="/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2011/01/24/performance-boost-in-clojure-1-3/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2011/01/24/performance-boost-in-clojure-1-3/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/2011/01/24/performance-boost-in-clojure-1-3/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> </div> <a href="/posts.html" title="posts" class="posts-menu-icon"></a> <!-- a title="/projects" class="projects-menu-icon"> <span></span> </a --> <div class="inner-post content"> <nav class="pagination"> <a href="/2010/09/30/sproutcore-encoding-gotchas/" class="pagination_pager" title="SproutCore encoding gotchas ">&lt; SproutCore encoding gotchas</a> <a href="/2011/05/10/more-clojure-for-spring-surf/" class="pagination_pager" title="More Clojure for Spring Surf ">More Clojure for Spring Surf &gt;</a> </nav> <div class="date-highlight">24 Jan 2011</div> <p>As release 1.3 of Clojure is <a href="http://www.assembla.com/spaces/clojure/milestones/238781-release-next">on its way</a>, I decided to give the currently available alpha4 a try and see some of the good stuff it brings. First thing first, I wanted to experiment myself with the performance gain that the extended support for native types would bring. I ran into an old <a href="http://hughw.blogspot.com/2009/01/clojure-vs-javafx-script-only-5x-slower.html">post</a> from which I got the inspiration for the specific test to run: the <a href="http://en.wikipedia.org/wiki/Tak_(function)">Takeuchi function</a>.</p> <p><img src="/img/post/clj-triple.jpg" alt="Full disclosure: I own a Triumph Street Triple and I love Clojure" /></p> <p>The Java implementation for Tak provided me with a bottom line for performance comparison: <script src="https://gist.github.com/788834.js?file=Tak.java"></script> Then I used the Clojure version provided in the original blog post run to test against Clojure 1.2: <script src="https://gist.github.com/788834.js?file=tak2.clj"></script></p> <p>Finally, I leveraged the new syntax for the <a href="http://dev.clojure.org/display/doc/Enhanced+Primitive+Support">enhanced primitives support</a> to test against Clojure 1.3 (thanks to <a href="http://twitter.com/neotyk">neotyk</a> to point that out to me): <script src="https://gist.github.com/788834.js?file=tak.clj"></script></p> <p>As you can see, timing is tracked from the application code, as various accessory overhead like JVM and Clojure runtime bootstrap are not in the scope of this post.</p> <p>As this benchmark is “just for fun”, I won’t pretent I did an extensive benchmark, or that I engineered a bullet proof benchmark strategy and the like. I just ran the above code some tens of times and here follows the average running time for the three versions:</p> <p><span style="color: #ff0000;">NOTE: an updated benchmark is provided down below</span> <span style="color: #ff0000;">NOTE2: to have a more fair performance comparison, <a href="#reloaded">keep reading</a></span> <img class="aligncenter size-full wp-image-344" title="Benchmark results" src="http://www.skuro.tk/wp-content/uploads/2011/01/clj-bench-graph.png" alt="Average running time in ms" width="467" height="292" /></p> <p>The results tells of a <strong>~4.5x</strong> speed gain<del>, getting close to match plain Java code performance</del>.</p> <p>Now, even if such a benchmark won’t be any news to the Clojure community, it’s still <strong>absolutely awesome</strong> to see such a performance gain in the next release of this beautiful Lispy language :-)</p> <p><strong>Update: </strong>following the advice by <strong>Jürgen Hötzel</strong> in his comment, I slightly modified my Clojure sources to change <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/-"><code class="highlighter-rouge">clojure.core/-</code></a> with <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/unchecked-subtract"><code class="highlighter-rouge">clojure.core/unchecked-subtract</code></a> and re-run the test. Here’s the final results, which are way better for Clojure, especially for version 1.2:</p> <p><img src="http://www.skuro.tk/wp-content/uploads/2011/01/clj-bench-graph-unchecked.png" alt="clj-bench-graph-unchecked" /></p> <p><strong>Update 2:</strong> the following graph shows the impact of the direct use of the <code class="highlighter-rouge">recur</code> special form tested against plain recursive invocation of Tak, as per requested in some comments <img class="aligncenter size-full wp-image-353" title="clj-bench-graph-norecur" src="http://www.skuro.tk/wp-content/uploads/2011/01/clj-bench-graph-norecur.png" alt="" width="476" height="267" /></p> <p><strong>Update 3:<a name="reloaded"></a></strong> even if this all started as a quick&amp;dirty, amatorial benchmark, it attracted quite some <a href="http://news.ycombinator.com/item?id=2134950">attentions</a>, demanding more fair and precise benchmarks, especially on the Java vs Clojure comparison. As in the Java version of Tak I used Integers and not primitive types, there is an unfair burden Java had to carry along the computation. The following is the result of a re-run of the test for Java (using primitive <span style="font-family: monospace;">long</span>) and Clojure 1.3: <img class="aligncenter size-full wp-image-356" title="clj-bench-reloaded" src="http://www.skuro.tk/wp-content/uploads/2011/01/clj-bench-reloaded.png" alt="" width="463" height="272" /></p> <br> <nav class="pagination"> <a href="/2010/09/30/sproutcore-encoding-gotchas/" class="pagination_pager" title="SproutCore encoding gotchas ">&lt; SproutCore encoding gotchas</a> <a href="/2011/05/10/more-clojure-for-spring-surf/" class="pagination_pager" title="More Clojure for Spring Surf ">More Clojure for Spring Surf &gt;</a> </nav> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2011/01/24/performance-boost-in-clojure-1-3/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2011/01/24/performance-boost-in-clojure-1-3/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/2011/01/24/performance-boost-in-clojure-1-3/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> <br /> <div id="disqus_thread"></div> <script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/ /* var disqus_config = function () { this.page.url = PAGE_URL; this.page.identifier = PAGE_IDENTIFIER; }; */ (function() { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = '//skuro.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </div> <!-- JS --> <script src="/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://taylantatli.me/Halve/images/halve-home-image.png) center center no-repeat;"> <a href="http://taylantatli.me/Halve" class="inactive" target="_blank" rel="nofollow external"> <span> Halve Jekyll Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://cloud.githubusercontent.com/assets/754514/14509720/61c61058-01d6-11e6-93ab-0918515ecd56.png) center center no-repeat;"> <a href="http://taylantatli.me/Moon" target="_blank" rel="nofollow external"> <span> Moon Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Ramme/master/assets/img/screenshot-post.png) center center no-repeat;"> <a href="http://taylantatli.me/Ramme" target="_blank" rel="nofollow external"> <span> Ramme Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Daisy-Pelican-Theme/master/Preview-1.png) center center no-repeat;"> <a href="http://taylantatli.me/Daisy-Pelican-Theme/" target="_blank" rel="nofollow external"> <span> Daisy Pelican Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Block-Icon-Theme/master/Preview.png) center center no-repeat;"> <a href="https://github.com/TaylanTatli/Block-Icon-Theme" class="inactive" target="_blank" rel="nofollow external"> <span> Block Icon Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/StartPage/master/preview.png) center center no-repeat;"> <a href="http://taylantatli.me/StartPage/" class="inactive" target="_blank" rel="nofollow external"> <span> Start Page <br><em>in progress</em> </span> </a> </li> </ul> </div> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-6754361-4', 'auto'); ga('send', 'pageview'); </script> </body> </html>
